<script>
const PROXY_URL = "https://corsproxy.io/?";
const API_BASE = "https://api.cartola.globo.com";

let cachedData = {
  atletas: null,
  clubes: null,
  partidas: null,
};

let selectedTeam = {};
let selectedReserves = {};
let selectedCaptain = null;

const FORMATION_433 = {
  1:{row:1,positions:[1]},
  2:{row:2,positions:[2,2]},
  3:{row:2,positions:[3,3]},
  4:{row:3,positions:[4,4,4]},
  5:{row:4,positions:[5,5,5]},
  6:{row:5,positions:[6]},
};

const POSITION_NAMES={
1:"Goleiro",
2:"Lateral",
3:"Zagueiro",
4:"Meia",
5:"Atacante",
6:"Técnico"
};

/* ================= API ================= */

async function fetchData(){
  const [clubesRes, partidasRes, atletasRes] = await Promise.all([
    fetch(PROXY_URL+encodeURIComponent(API_BASE+"/clubes")),
    fetch(PROXY_URL+encodeURIComponent(API_BASE+"/partidas")),
    fetch(PROXY_URL+encodeURIComponent(API_BASE+"/atletas/mercado"))
  ]);

  cachedData.clubes = await clubesRes.json();
  cachedData.partidas = await partidasRes.json();
  const atletasData = await atletasRes.json();

  cachedData.atletas = atletasData.atletas || [];
}

/* ================= IA SCORE ================= */

function calculateAIScore(p){
  let score = 0;

  const media = p.media_num || 0;
  const preco = p.preco_num || 1;
  const variacao = p.variacao_num || 0;

  score += media*12;
  score += variacao*8;
  score += (media/preco)*15;

  if(p.jogos_num>=3) score+=8;
  if(p.posicao_id===5) score+=6;

  return score;
}

/* ================= ANALISE ================= */

async function analyzeTeam(){

  document.getElementById("analyzeBtn").disabled=true;

  await fetchData();

  const budget=parseFloat(document.getElementById("budget").value)||100;

  const byPos={};
  for(let i=1;i<=6;i++){
    byPos[i]=cachedData.atletas.filter(a=>a.posicao_id===i && a.status_id===7);
  }

  selectedTeam={};
  selectedReserves={};
  selectedCaptain=null;

  let remaining=budget;
  let projected=0;
  const usedIds=new Set();

  const priority=[1,3,5,4,2,6];

  priority.forEach(pos=>{
    const needed=FORMATION_433[pos].positions.length;

    const ranked=byPos[pos]
      .map(p=>({...p,aiScore:calculateAIScore(p)}))
      .sort((a,b)=>b.aiScore-a.aiScore);

    selectedTeam[pos]=[];

    for(let player of ranked){
      if(selectedTeam[pos].length>=needed) break;
      if(!usedIds.has(player.id) && player.preco_num<=remaining){
        selectedTeam[pos].push(player);
        remaining-=player.preco_num;
        projected+=player.media_num||0;
        usedIds.add(player.id);
      }
    }

    // reserva
    const reserve=ranked.find(p=>!usedIds.has(p.id));
    if(reserve){
      selectedReserves[pos]=reserve;
      usedIds.add(reserve.id);
    }
  });

  // Capitão IA
  Object.values(selectedTeam).flat().forEach(p=>{
    if(!selectedCaptain || p.aiScore>selectedCaptain.aiScore){
      selectedCaptain=p;
    }
  });

  renderTeam();
  renderReserves();
  renderMatchups();
  renderSummary(budget,remaining,projected);

  document.getElementById("analyzeBtn").disabled=false;
}

/* ================= RENDER CAMPO ================= */

function renderTeam(){
  const container=document.getElementById("teamFormation");
  container.innerHTML="";
  const rows={};

  Object.entries(FORMATION_433).forEach(([pos,config])=>{
    if(!rows[config.row]) rows[config.row]=[];

    (selectedTeam[pos]||[]).forEach(player=>{
      rows[config.row].push(createPlayerCard(player));
    });
  });

  Object.keys(rows).sort((a,b)=>a-b).forEach(r=>{
    const row=document.createElement("div");
    row.className="position-row";
    rows[r].forEach(el=>row.appendChild(el));
    container.appendChild(row);
  });
}

function createPlayerCard(player){
  const div=document.createElement("div");
  div.className="player-position";

  const clube=cachedData.clubes[player.clube_id]?.abreviacao||"";

  div.innerHTML=`
    <div class="pos-label">${POSITION_NAMES[player.posicao_id]}</div>
    <div class="player-name-field">${player.apelido}</div>
    <div class="player-team-field">${clube}</div>
    <div class="player-price-field">C$ ${player.preco_num.toFixed(2)}</div>
  `;

  if(selectedCaptain && selectedCaptain.id===player.id){
    const badge=document.createElement("div");
    badge.className="captain-badge";
    badge.innerText="C";
    div.appendChild(badge);
  }

  return div;
}

/* ================= RESERVAS ================= */

function renderReserves(){
  const container=document.getElementById("reservesList");
  container.innerHTML="";

  Object.values(selectedReserves).forEach(p=>{
    const div=document.createElement("div");
    div.className="reserve-item";

    div.innerHTML=`
      <div class="pos-label">${POSITION_NAMES[p.posicao_id]}</div>
      <div>${p.apelido}</div>
      <div>C$ ${p.preco_num.toFixed(2)}</div>
    `;

    container.appendChild(div);
  });
}

/* ================= CONFRONTOS ================= */

function renderMatchups(){
  const container=document.getElementById("matchupList");
  container.innerHTML="";

  cachedData.partidas.partidas.forEach(m=>{
    const casa=cachedData.clubes[m.clube_casa_id]?.abreviacao;
    const fora=cachedData.clubes[m.clube_visitante_id]?.abreviacao;

    const div=document.createElement("div");
    div.className="matchup-item";
    div.innerHTML=`${casa} vs ${fora}`;

    container.appendChild(div);
  });
}

/* ================= RESUMO ================= */

function renderSummary(budget,remaining,projected){
  document.getElementById("totalCost").innerText=
    "C$ "+(budget-remaining).toFixed(2);

  document.getElementById("remainingBudget").innerText=
    "C$ "+remaining.toFixed(2);

  document.getElementById("projectedPoints").innerText=
    projected.toFixed(2);

  document.getElementById("avgCostBenefit").innerText=
    ((projected||1)/(budget-remaining||1)).toFixed(2);

  document.getElementById("tacticalAnalysis").innerText=
    "Time montado automaticamente pela IA priorizando média, valorização e custo-benefício.";
}

/* ================= BOTÃO ================= */

document
.getElementById("analyzeBtn")
.addEventListener("click", analyzeTeam);
</script>
